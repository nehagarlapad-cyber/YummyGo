<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - YummyGo</title>
    <link rel="stylesheet" href="/css/design-system.css">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">üçï YummyGo</a>
        </div>
    </nav>

    <div class="container section">
        <h1 class="mb-3">Checkout</h1>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <div>
                <form id="checkoutForm">
                    <div class="card mb-2">
                        <h3 class="mb-2">Delivery Address</h3>
                        <div class="form-group">
                            <label class="form-label">Street Address</label>
                            <input type="text" id="street" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">City</label>
                            <input type="text" id="city" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ZIP Code</label>
                            <input type="text" id="zipCode" class="form-input" required>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <h3 class="mb-2">Payment Method</h3>
                        <div class="form-group">
                            <select id="paymentMethod" class="form-select">
                                <option value="cash">Cash on Delivery</option>
                                <option value="card">Card</option>
                                <option value="upi">UPI</option>
                            </select>
                        </div>
                    </div>

                    <div class="card mb-2">
                        <h3 class="mb-2">Promo Code</h3>
                        <div style="display: flex; gap: 1rem;">
                            <input type="text" id="promoCode" class="form-input" placeholder="Enter promo code">
                            <button type="button" class="btn btn-secondary" onclick="applyPromo()">Apply</button>
                        </div>
                        <p id="promoMessage" class="text-muted mt-1"></p>
                    </div>
                </form>
            </div>

            <div>
                <div class="card" id="orderSummary">
                    <div class="flex-center">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        let cart = null;
        let promoDiscount = 0;

        (async () => {
            const user = await requireAuth(['customer']);
            if (!user) return;

            await loadCart();
        })();

        async function loadCart() {
            try {
                const response = await API.customer.getCart();
                cart = response.data;

                if (!cart || !cart.items || cart.items.length === 0) {
                    Utils.showToast('Cart is empty', 'error');
                    window.location.href = '/customer/cart.html';
                    return;
                }

                renderSummary();
            } catch (error) {
                Utils.showToast('Failed to load cart', 'error');
            }
        }

        function renderSummary() {
            const subtotal = cart.items.reduce((sum, item) => sum + (item.menuItem.price * item.quantity), 0);
            const deliveryFee = 50;
            const tax = subtotal * 0.05;
            const total = subtotal + deliveryFee + tax - promoDiscount;

            document.getElementById('orderSummary').innerHTML = `
        <h3 class="mb-2">Order Summary</h3>
        <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--light-gray);">
          <div style="display: flex; justify-content: space-between;">
            <span>Subtotal</span>
            <span>${Utils.formatCurrency(subtotal)}</span>
          </div>
        </div>
        <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--light-gray);">
          <div style="display: flex; justify-content: space-between;">
            <span>Delivery Fee</span>
            <span>${Utils.formatCurrency(deliveryFee)}</span>
          </div>
        </div>
        <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--light-gray);">
          <div style="display: flex; justify-content: space-between;">
            <span>Tax</span>
            <span>${Utils.formatCurrency(tax)}</span>
          </div>
        </div>
        ${promoDiscount > 0 ? `
          <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--light-gray); color: var(--success);">
            <div style="display: flex; justify-content: space-between;">
              <span>Promo Discount</span>
              <span>-${Utils.formatCurrency(promoDiscount)}</span>
            </div>
          </div>
        ` : ''}
        <div style="padding: 1rem 0; font-size: 1.25rem; font-weight: 700;">
          <div style="display: flex; justify-content: space-between;">
            <span>Total</span>
            <span>${Utils.formatCurrency(total)}</span>
          </div>
        </div>
        <button class="btn btn-primary" style="width: 100%;" onclick="placeOrder()">Place Order</button>
      `;
        }

        function applyPromo() {
            const code = document.getElementById('promoCode').value;
            // Simple promo simulation - in real app, this would be validated by backend
            if (code.toUpperCase() === 'PIZZA50') {
                promoDiscount = 50;
                document.getElementById('promoMessage').textContent = '‚úÖ Promo applied! ‚Çπ50 off';
                document.getElementById('promoMessage').style.color = 'var(--success)';
            } else if (code) {
                document.getElementById('promoMessage').textContent = '‚ùå Invalid promo code';
                document.getElementById('promoMessage').style.color = 'var(--error)';
            }
            renderSummary();
        }

        async function placeOrder() {
            const deliveryAddress = {
                street: document.getElementById('street').value,
                city: document.getElementById('city').value,
                zipCode: document.getElementById('zipCode').value,
            };

            const paymentMethod = document.getElementById('paymentMethod').value;
            const promoCode = document.getElementById('promoCode').value;

            if (!deliveryAddress.street || !deliveryAddress.city || !deliveryAddress.zipCode) {
                Utils.showToast('Please fill in all address fields', 'error');
                return;
            }

            try {
                const response = await API.customer.placeOrder({
                    deliveryAddress,
                    paymentMethod,
                    promoCode: promoCode || undefined
                });

                Utils.showToast('Order placed successfully!', 'success');
                setTimeout(() => {
                    window.location.href = `/customer/tracking.html?id=${response.data._id}`;
                }, 1000);
            } catch (error) {
                Utils.showToast(error.message, 'error');
            }
        }
    </script>
</body>

</html>